<aside class="sidebar-wrapper">
      <div class="sidebar">
            <div class="sidebar-container">
                  {% for imp in dynamics.sidebar.top %}
                        {% include imp %}
                  {% endfor %}
                  {%if settings.dgShowLocalGraph === true and page.fileSlug != '网站内容索引-Index'%}
                        {%include "components/graphScript.njk"%}
                  {%endif%}

                  {%if settings.dgShowToc === true%}
                        {%set tocHtml= (content and (content|toc)) %}
                        {%if tocHtml %}
                              <div class="toc">
                                    <div class="toc-title-container">
                                          <div class="toc-title">
                                                大纲 OutLine
                                          </div>
                                    </div>
                                    <div class="toc-container">
                                          {{ tocHtml | safe }}
                                    </div>
                              </div>
                        {%endif%}

                  {%endif%}

                        {%if settings.dgShowBacklinks === true %}
                              {%if settings.dgShowBacklinks === true %}
                              <div class="backlinks">
                                    <div class="backlink-title" style="margin: 4px 0 !important;">反向链接 Backlink</div>
                                          <div class="backlink-list">
                                          {%- if page.url == "/" -%}
                                                {%- if graph.nodes[graph.homeAlias].backLinks.length === 0 -%}
                                                      <div class="backlink-card">
                                                            <span class="no-backlinks-message">No other pages mentions this page</span>
                                                      </div>
                                                {%- endif -%}
                                          {%- for backlink in graph.nodes[graph.homeAlias].backLinks -%}
                                                {%- if graph.nodes[backlink].url != graph.homeAlias -%}
                                                <div class="backlink-card">
                                                      {%- if not meta.noteIconsSettings.backlinks -%}<i  icon-name="link"></i> {%- endif -%}<a href="{{graph.nodes[backlink].url}}" data-note-icon="{{graph.nodes[backlink].noteIcon}}" class="backlink">{{graph.nodes[backlink].title}}</a>
                                                </div>
                                                {%- endif -%}
                                          {%- endfor -%}
                                          {%- else -%}
                                                {%- if graph.nodes[page.url].backLinks.length === 0 -%}
                                                      <div class="backlink-card">
                                                            <span class="no-backlinks-message">No other pages mentions this page</span>
                                                      </div>
                                                {%- endif -%}
                                          {%- for backlink in graph.nodes[page.url].backLinks -%}
                                                {%- if graph.nodes[backlink].url != page.url -%}
                                                <div class="backlink-card">
                                                      {%- if not meta.noteIconsSettings.backlinks -%}<i  icon-name="link"></i> {%- endif -%}<a href="{{graph.nodes[backlink].url}}" data-note-icon="{{graph.nodes[backlink].noteIcon}}" class="backlink">{{graph.nodes[backlink].title}}</a>
                                                </div>
                                                {%- endif -%}
                                          {%- endfor -%}
                                    {%- endif -%}
                                    </div>
                              </div>
                        {%endif%}
                  {%endif%}
                  {% for imp in dynamics.sidebar.bottom %}
                        {% include imp %}
                  {% endfor %}
                  <div id="pwa-actions-container" style="margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                        <button id="install-pwa-button" class="install-pwa-button">安装</button>
                        <button id="refresh-cache-button" class="install-pwa-button">刷新</button>
                  </div>
            </div>
      </div>
</aside>
<script>
    let installPromptEvent;

    // Listen for the custom event dispatched from pageheader.njk
    window.addEventListener('pwa_prompt_available', (e) => {
        installPromptEvent = e.detail;
        const installButton = document.getElementById('install-pwa-button');
        if (installButton) {
            installButton.style.display = 'block'; // Show install button when prompt is available
        }
    });

    // PWA Install Button Logic (no longer creating, just handling clicks)
    document.addEventListener('DOMContentLoaded', () => {
        const installButton = document.getElementById('install-pwa-button');
        if (installButton) {
            installButton.addEventListener('click', () => {
                installButton.style.display = 'none'; // Hide button after click
                if (installPromptEvent) {
                    installPromptEvent.prompt();
                    installPromptEvent.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the PWA install prompt');
                        } else {
                            console.log('User dismissed the PWA install prompt');
                        }
                        installPromptEvent = null;
                    });
                }
            });
        }
    });


    // Refresh Cache Button Logic
    document.addEventListener('DOMContentLoaded', () => {
        const refreshButton = document.getElementById('refresh-cache-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    console.log('Client: Requesting cache clear and reload from Service Worker.');
                    // Display a temporary message to the user
                    refreshButton.textContent = '正在刷新...';
                    refreshButton.disabled = true;

                    navigator.serviceWorker.controller.postMessage({
                        type: 'CLEAR_CACHE_AND_RELOAD'
                    });
                    // Service Worker will handle the reload
                } else {
                    alert('Service Worker 不可用或未激活。请尝试手动刷新页面。');
                    location.reload(true); // Force reload if SW not active
                }
            });
        }
    });
</script>
